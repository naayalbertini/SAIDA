<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Entrega de Material • Estoque por Turma</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --accent:#2b7cff;
      --accent-2:#1e40af;
      --accent-light:#eef4ff;
      --muted:#6b7280;
      --text:#0f172a;
      --border:#e6e9ef;
      --danger:#ef4444;
      --danger-light:#fef2f2;
      --success:#16a34a;
      --success-light:#ecfdf5;
      --shadow: 0 6px 18px rgba(12,18,40,0.08);
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text);}
    header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;background:var(--card);
      border-bottom:1px solid var(--border);
    }
    header .title{display:flex;flex-direction:column;gap:2px}
    header h1{margin:0;font-size:16px;font-weight:800;letter-spacing:0.2px}
    header .sub{font-size:12px;color:var(--muted)}
    header .right{display:flex;gap:10px;align-items:center}
    .pill{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:13px;color:var(--muted)}
    .btn{
      border:0;border-radius:12px;padding:10px 14px;
      background:var(--accent);color:#fff;font-weight:600;
      cursor:pointer;box-shadow:0 3px 10px rgba(43,124,255,0.22);
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--border);box-shadow:none}
    .btn.danger{background:var(--danger);box-shadow:0 3px 10px rgba(239,68,68,0.22)}
    .container{max-width:1280px;margin:16px auto;padding:0 16px;}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .card .hd{padding:14px 14px 10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .hd h2{margin:0;font-size:14px;font-weight:800}
    .card .bd{padding:14px;}
    .input, select{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);
      outline:none;font-size:16px;background:#fff;
    }
    .input:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(43,124,255,0.12)}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .class-item, .student-item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;
      cursor:pointer;
    }
    .class-item.active, .student-item.active{border-color:var(--accent);background:var(--accent-light)}
    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);background:#fff;
    }
    .material-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .mat-card{
      border:1px solid var(--border);border-radius:16px;background:#fff;
      padding:14px;cursor:pointer;transition:transform .08s, box-shadow .08s, border-color .08s;
      display:flex;flex-direction:column;gap:10px;min-height:110px;
    }
    .mat-card:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(12,18,40,0.10);border-color:rgba(43,124,255,0.35)}
    .mat-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .mat-name{font-weight:800;font-size:14px;line-height:1.2}
    .mat-meta{font-size:12px;color:var(--muted)}
    .qty{
      font-weight:900;font-size:22px;line-height:1;
      color:var(--accent-2);
      min-width:56px;text-align:right;
    }
    .qty.low{color:var(--danger)}
    .qty.ok{color:var(--accent-2)}
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:50;
      background:#0b1220;color:#fff;border-radius:14px;padding:12px 14px;
      box-shadow:0 14px 40px rgba(0,0,0,0.25);
      display:none;max-width:min(420px,calc(100vw - 32px));
      font-size:13px;line-height:1.35;
    }

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;z-index:40;align-items:center;justify-content:center;padding:14px}
    .modal{width:min(980px,100%);background:var(--card);border-radius:18px;border:1px solid var(--border);box-shadow:0 30px 80px rgba(0,0,0,0.25);overflow:hidden}
    .modal .mhd{padding:14px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal .mhd .left{display:flex;flex-direction:column;gap:2px}
    .modal .mhd .t{font-weight:900;font-size:15px}
    .modal .mhd .s{font-size:12px;color:var(--muted)}
    .modal .mbd{padding:14px}
    .split{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .table{width:100%;border-collapse:separate;border-spacing:0 10px}
    .table th{font-size:12px;color:var(--muted);text-align:left;font-weight:700;padding:0 10px}
    .table td{background:#fff;border:1px solid var(--border);padding:10px;border-left:0;border-right:0}
    .table tr td:first-child{border-left:1px solid var(--border);border-radius:12px 0 0 12px}
    .table tr td:last-child{border-right:1px solid var(--border);border-radius:0 12px 12px 0;text-align:right;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .kpi{display:flex;gap:10px;align-items:center}
    .kpi .box{flex:1;background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px}
    .kpi .box .n{font-size:18px;font-weight:900}
    .kpi .box .l{font-size:12px;color:var(--muted)}
    .danger-note{background:var(--danger-light);border:1px solid var(--danger);color:#7f1d1d;padding:10px;border-radius:12px;font-size:13px}
    .success-note{background:var(--success-light);border:1px solid var(--success);color:#14532d;padding:10px;border-radius:12px;font-size:13px}
    .hide{display:none !important;}

    /* Login overlay */
    #loginWrap{position:fixed;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#eef4ff,#f5f7fb);}
    #loginCard{width:min(440px,100%);margin:14px;background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.18);padding:18px}
    #loginCard h2{margin:0 0 6px 0;font-size:18px;font-weight:900}
    #loginCard p{margin:0 0 12px 0;color:var(--muted);font-size:13px}
    #app{display:none;}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .material-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
      .split{grid-template-columns:1fr}
    }
    @media (max-width: 520px){
      .material-grid{grid-template-columns:1fr}
      header{position:static}
    }
  </style>
</head>
<body>

<div id="loginWrap">
  <div id="loginCard">
    <h2>Entrega de Material</h2>
    <p>Faça login com o mesmo acesso do sistema principal.</p>
    <div class="list">
      <input id="email" class="input" type="email" placeholder="E-mail" autocomplete="username"/>
      <input id="password" class="input" type="password" placeholder="Senha" autocomplete="current-password"/>
      <button id="btnLogin" class="btn">Entrar</button>
      <div id="loginMsg" class="danger-note hide"></div>
      <div class="small">Dica: se não logar, confirme se o e-mail/senha existem no Firebase Authentication e se o domínio está autorizado.</div>
    </div>
  </div>
</div>

<div id="app">
  <header>
    <div class="title">
      <h1>Entrega de Material • Estoque por Turma</h1>
      <div class="sub">Selecione uma turma → veja o total por item → clique no item para ver quais alunos já pegaram.</div>
    </div>
    <div class="right">
      <div id="userPill" class="pill">—</div>
      <button id="btnLogout" class="btn secondary">Sair</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div class="hd">
          <h2>Turmas</h2>
          <span class="badge" id="classesCount">0</span>
        </div>
        <div class="bd">
          <select id="classSelect"></select>
          <div style="height:10px"></div>
          <div id="classesList" class="list" style="max-height:320px;overflow:auto;padding-right:4px;"></div>

          <div style="height:14px"></div>
          <div class="row">
            <input id="studentSearch" class="input" placeholder="Buscar aluno na turma…"/>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <div class="small" id="studentsHint">Selecione uma turma para listar alunos.</div>
          </div>
          <div style="height:10px"></div>
          <div id="studentsList" class="list" style="max-height:360px;overflow:auto;padding-right:4px;"></div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="hd">
          <h2 id="rightTitle">Estoque da turma</h2>
          <div class="kpi" style="min-width:280px">
            <div class="box">
              <div class="n" id="kpiItems">—</div>
              <div class="l">Itens</div>
            </div>
            <div class="box">
              <div class="n" id="kpiLow">—</div>
              <div class="l">Baixo estoque</div>
            </div>
          </div>
        </div>
        <div class="bd">
          <div id="emptyState" class="hint">Selecione uma turma para ver os materiais e o total disponível.</div>
          <div id="materialsWrap" class="hide">
            <div class="small" id="materialsSub"></div>
            <div style="height:12px"></div>
            <div id="materialsGrid" class="material-grid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Material Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mhd">
        <div class="left">
          <div class="t" id="modalTitle">Material</div>
          <div class="s" id="modalSubtitle">—</div>
        </div>
        <div class="right">
          <button class="btn secondary" id="btnCloseModal">Fechar</button>
        </div>
      </div>
      <div class="mbd">
        <div class="split">
          <div>
            <div class="kpi">
              <div class="box">
                <div class="n" id="modalQty">—</div>
                <div class="l">Total disponível na turma</div>
              </div>
              <div class="box">
                <div class="n" id="modalDeliveredCount">—</div>
                <div class="l">Alunos que já pegaram</div>
              </div>
            </div>

            <div style="height:12px"></div>
            <div class="row">
              <input id="deliveryFilter" class="input" placeholder="Filtrar por nome do aluno…"/>
            </div>

            <div style="height:12px"></div>
            <table class="table">
              <thead>
                <tr>
                  <th>Aluno</th>
                  <th>Qtd</th>
                  <th>Professor</th>
                  <th style="text-align:right">Data/Hora</th>
                </tr>
              </thead>
              <tbody id="deliveriesTbody"></tbody>
            </table>
            <div id="noDeliveries" class="small muted">Nenhuma entrega registrada para este material nesta turma.</div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd">
              <h2>Registrar entrega</h2>
              <span class="badge" id="selectedStudentBadge">—</span>
            </div>
            <div class="bd">
              <div class="list">
                <div>
                  <div class="small">Aluno</div>
                  <select id="studentSelect"></select>
                </div>
                <div>
                  <div class="small">Quantidade</div>
                  <input id="qtyInput" class="input" type="number" min="1" step="1" value="1"/>
                  <div class="small">Vai baixar do estoque total da turma.</div>
                </div>
                <div>
                  <div class="small">Professor (obrigatório)</div>
                  <input id="teacherInput" class="input" placeholder="Ex.: Prof. Ana"/>
                </div>

                <div style="height:6px"></div>
                <button id="btnConfirmDelivery" class="btn">Confirmar entrega</button>

                <div style="height:10px"></div>
                <div class="small">Entrada/Ajuste de estoque (opcional)</div>
                <div class="row">
                  <input id="addQty" class="input" type="number" step="1" placeholder="+10 (entrada) ou -3 (ajuste)"/>
                  <button id="btnAddStock" class="btn secondary" style="flex:0 0 auto">Aplicar</button>
                </div>
                <div id="actionMsg" class="danger-note hide"></div>
                <div class="small">Dica: use ajuste negativo apenas para correção de inventário.</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Firebase v8 (mesmo do sistema principal) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ========= Firebase Config (copiado do seu sistema) ========= */
const firebaseConfig = {
  apiKey: "AIzaSyDNpnxlyLEu6OqP_fN3SRtWpSRvZFkuAXI",
  authDomain: "materialescolar-126da.firebaseapp.com",
  projectId: "materialescolar-126da",
  storageBucket: "materialescolar-126da.firebasestorage.app",
  messagingSenderId: "498322809036",
  appId: "1:498322809036:web:ee71b80840ee8dc2676269"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ========= Coleções (ajuste aqui se seus nomes forem diferentes) ========= */
const COL = {
  classes: "classes",
  students: "students",
  materials: "materials",
  classStock: "class_stock",
  deliveries: "deliveries"
};

const $ = (id) => document.getElementById(id);

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> el.style.display = "none", 2800);
}

function fmtDate(ts){
  if(!ts) return "—";
  const d = ts.toDate ? ts.toDate() : (ts.seconds ? new Date(ts.seconds*1000) : new Date(ts));
  return d.toLocaleString("pt-BR");
}

let state = {
  classes: [],
  students: [],
  materials: [],
  stockByMaterialId: new Map(), // materialId -> qty
  activeClassId: null,
  activeClassName: null,
  activeMaterial: null, // {id,name}
  deliveriesCache: [], // deliveries for active class (optional)
};

async function safeGetName(docSnap, fallback){
  try{
    const d = docSnap.data();
    return d.name || d.nome || d.title || fallback;
  }catch(e){ return fallback; }
}

/* ========= Login ========= */
$("btnLogin").onclick = async () => {
  $("loginMsg").classList.add("hide");
  const email = $("email").value.trim();
  const password = $("password").value;
  try{
    await auth.signInWithEmailAndPassword(email, password);
  }catch(err){
    console.error(err);
    $("loginMsg").textContent = err.message || "Falha ao logar.";
    $("loginMsg").classList.remove("hide");
  }
};

$("btnLogout").onclick = async () => {
  await auth.signOut();
};

auth.onAuthStateChanged(async (user) => {
  if(!user){
    $("loginWrap").style.display = "flex";
    $("app").style.display = "none";
    return;
  }
  $("userPill").textContent = user.email || "Logado";
  $("loginWrap").style.display = "none";
  $("app").style.display = "block";
  await boot();
});

/* ========= Boot ========= */
async function boot(){
  await loadClasses();
  bindUI();
}

function bindUI(){
  $("classSelect").onchange = () => {
    const id = $("classSelect").value;
    const cls = state.classes.find(c => c.id === id);
    if(cls) setActiveClass(cls.id, cls.name);
  };
  $("studentSearch").oninput = () => renderStudentsList();
  $("btnCloseModal").onclick = closeModal;
  $("modalBackdrop").addEventListener("click",(e)=>{ if(e.target === $("modalBackdrop")) closeModal(); });

  $("deliveryFilter").oninput = () => renderDeliveriesTable();
  $("studentSelect").onchange = () => {
    const s = state.students.find(x => x.id === $("studentSelect").value);
    $("selectedStudentBadge").textContent = s ? (s.name || "Aluno") : "—";
  };

  $("btnConfirmDelivery").onclick = confirmDelivery;
  $("btnAddStock").onclick = applyStockAdjust;
}

/* ========= Load data ========= */
async function loadClasses(){
  const snap = await db.collection(COL.classes).get();
  const classes = [];
  snap.forEach(doc => {
    const data = doc.data() || {};
    classes.push({ id: doc.id, name: data.name || data.nome || ("Turma " + doc.id) });
  });
  classes.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  state.classes = classes;
  $("classesCount").textContent = classes.length;

  // select list
  $("classSelect").innerHTML = `<option value="">Selecione…</option>` + classes.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
  renderClassesList();

  // auto select first
  if(classes.length){
    setActiveClass(classes[0].id, classes[0].name);
    $("classSelect").value = classes[0].id;
  }
}

function renderClassesList(){
  const el = $("classesList");
  el.innerHTML = "";
  for(const c of state.classes){
    const div = document.createElement("div");
    div.className = "class-item" + (c.id === state.activeClassId ? " active" : "");
    div.innerHTML = `<div style="display:flex;flex-direction:column;gap:2px">
        <div style="font-weight:800">${escapeHtml(c.name)}</div>
        <div class="small">ID: ${escapeHtml(c.id)}</div>
      </div>
      <span class="badge">Abrir</span>`;
    div.onclick = () => { $("classSelect").value = c.id; setActiveClass(c.id, c.name); };
    el.appendChild(div);
  }
}

async function setActiveClass(classId, className){
  state.activeClassId = classId;
  state.activeClassName = className;
  $("rightTitle").textContent = `Estoque da turma • ${className}`;
  $("studentsHint").textContent = "Carregando alunos…";
  $("emptyState").classList.add("hide");
  $("materialsWrap").classList.add("hide");

  renderClassesList();
  await Promise.all([loadStudentsForClass(classId), loadMaterialsAndStockForClass(classId)]);
  $("studentsHint").textContent = `Alunos da turma: ${state.students.length}`;
  renderStudentsList();
  renderMaterialsGrid();
}

async function loadStudentsForClass(classId){
  state.students = [];
  // tenta 'classId' e fallback 'turmaId'
  let snap = await db.collection(COL.students).where("classId","==",classId).get().catch(()=>null);
  if(!snap || snap.empty){
    snap = await db.collection(COL.students).where("turmaId","==",classId).get().catch(()=>null);
  }
  if(!snap) return;
  snap.forEach(doc=>{
    const d = doc.data()||{};
    state.students.push({
      id: doc.id,
      name: d.name || d.nome || d.fullName || ("Aluno " + doc.id),
      ra: d.ra || d.RA || d.matricula || ""
    });
  });
  state.students.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  // populate select in modal too
  $("studentSelect").innerHTML = state.students.map(s => `<option value="${s.id}">${escapeHtml(s.name)}${s.ra?` • RA ${escapeHtml(String(s.ra))}`:""}</option>`).join("");
  const first = state.students[0];
  $("selectedStudentBadge").textContent = first ? first.name : "—";
}

function renderStudentsList(){
  const q = $("studentSearch").value.trim().toLowerCase();
  const el = $("studentsList");
  el.innerHTML = "";
  if(!state.activeClassId){ return; }
  const items = state.students.filter(s => !q || (s.name||"").toLowerCase().includes(q) || String(s.ra||"").includes(q));
  for(const s of items.slice(0,200)){
    const div = document.createElement("div");
    div.className = "student-item";
    div.innerHTML = `<div style="display:flex;flex-direction:column;gap:2px">
        <div style="font-weight:800">${escapeHtml(s.name)}</div>
        <div class="small">${s.ra?("RA: "+escapeHtml(String(s.ra))+" • "):""}ID: ${escapeHtml(s.id)}</div>
      </div>
      <span class="badge">Selecionar</span>`;
    div.onclick = () => {
      $("studentSelect").value = s.id;
      $("selectedStudentBadge").textContent = s.name;
      toast("Aluno selecionado para entrega: " + s.name);
    };
    el.appendChild(div);
  }
}

async function loadMaterialsAndStockForClass(classId){
  state.materials = [];
  state.stockByMaterialId = new Map();

  // carrega materiais da turma
  const matsSnap = await db.collection(COL.materials).where("classId","==",classId).get().catch(()=>null);
  if(matsSnap){
    matsSnap.forEach(doc=>{
      const d=doc.data()||{};
      state.materials.push({ id: doc.id, name: d.name || d.nome || ("Material " + doc.id) });
    });
  }
  state.materials.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

  // carrega estoque por item (subcoleção)
  const stockSnap = await db.collection(COL.classStock).doc(classId).collection("items").get().catch(()=>null);
  if(stockSnap){
    stockSnap.forEach(doc=>{
      const d=doc.data()||{};
      state.stockByMaterialId.set(doc.id, Number(d.qty||0));
    });
  }

  // Se existir estoque pra item que não está em materials (por exemplo materialId = doc.id no materials), a gente mostra também
  const materialIds = new Set(state.materials.map(m=>m.id));
  for(const [mid, qty] of state.stockByMaterialId.entries()){
    if(!materialIds.has(mid)){
      state.materials.push({ id: mid, name: mid }); // fallback
    }
  }
  state.materials.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

  $("materialsSub").textContent = `Clique em um material para ver quem já pegou e registrar novas entregas.`;
  $("materialsWrap").classList.remove("hide");
  $("emptyState").classList.add("hide");

  // KPIs
  $("kpiItems").textContent = state.materials.length;
  let low = 0;
  for(const m of state.materials){
    const qty = Number(state.stockByMaterialId.get(m.id) || 0);
    if(qty <= 3) low++;
  }
  $("kpiLow").textContent = low;

  renderMaterialsGrid();
}

/* ========= Materials grid ========= */
function renderMaterialsGrid(){
  const grid = $("materialsGrid");
  grid.innerHTML = "";
  if(!state.activeClassId){
    $("emptyState").classList.remove("hide");
    $("materialsWrap").classList.add("hide");
    return;
  }
  for(const m of state.materials){
    const qty = Number(state.stockByMaterialId.get(m.id) || 0);
    const div = document.createElement("div");
    div.className = "mat-card";
    div.innerHTML = `
      <div class="mat-top">
        <div style="min-width:0">
          <div class="mat-name">${escapeHtml(m.name)}</div>
          <div class="mat-meta">ID: ${escapeHtml(m.id)}</div>
        </div>
        <div class="qty ${qty<=3?'low':'ok'}">${qty}</div>
      </div>
      <div class="small">Toque para ver entregas desta turma</div>
    `;
    div.onclick = () => openMaterialModal(m);
    grid.appendChild(div);
  }
}

/* ========= Modal: deliveries for a material ========= */
async function openMaterialModal(material){
  state.activeMaterial = material;
  $("actionMsg").classList.add("hide");
  $("qtyInput").value = 1;
  $("addQty").value = "";
  $("teacherInput").value = "";

  $("modalTitle").textContent = material.name;
  $("modalSubtitle").textContent = `Turma: ${state.activeClassName} • Material: ${material.id}`;
  const qty = Number(state.stockByMaterialId.get(material.id) || 0);
  $("modalQty").textContent = qty;

  $("deliveriesTbody").innerHTML = "";
  $("noDeliveries").style.display = "none";
  $("modalDeliveredCount").textContent = "—";
  $("deliveryFilter").value = "";

  $("modalBackdrop").style.display = "flex";

  await loadDeliveriesForActiveMaterial();
}

function closeModal(){
  $("modalBackdrop").style.display = "none";
  state.activeMaterial = null;
  state.deliveriesCache = [];
}

async function loadDeliveriesForActiveMaterial(){
  const mat = state.activeMaterial;
  if(!mat || !state.activeClassId) return;

  // Busca entregas deste material e turma
  // Estrutura esperada do delivery doc:
  // { classId, materialId, materialName, studentId, studentName, qty, teacherName, deliveredAt }
  let q = db.collection(COL.deliveries)
    .where("classId","==",state.activeClassId)
    .where("materialId","==",mat.id)
    .orderBy("deliveredAt","desc")
    .limit(200);

  const snap = await q.get().catch(err=>{
    console.error(err);
    $("actionMsg").textContent = "Erro ao buscar entregas. Se aparecer mensagem de índice, crie o índice no Firestore (classId + materialId + deliveredAt).";
    $("actionMsg").classList.remove("hide");
    return null;
  });

  const rows = [];
  if(snap){
    snap.forEach(doc=>{
      const d = doc.data()||{};
      rows.push({
        id: doc.id,
        studentId: d.studentId || "",
        studentName: d.studentName || d.alunoNome || "",
        qty: Number(d.qty||0),
        teacherName: d.teacherName || d.professor || "",
        deliveredAt: d.deliveredAt || null
      });
    });
  }

  state.deliveriesCache = rows;
  $("modalDeliveredCount").textContent = String(new Set(rows.map(r=>r.studentId||r.studentName)).size || 0);
  renderDeliveriesTable();
}

function renderDeliveriesTable(){
  const filter = $("deliveryFilter").value.trim().toLowerCase();
  const tbody = $("deliveriesTbody");
  tbody.innerHTML = "";

  const rows = state.deliveriesCache.filter(r => !filter || (r.studentName||"").toLowerCase().includes(filter));
  if(!rows.length){
    $("noDeliveries").style.display = "block";
    return;
  }
  $("noDeliveries").style.display = "none";

  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escapeHtml(r.studentName || r.studentId)}</strong></td>
      <td>${r.qty}</td>
      <td class="muted">${escapeHtml(r.teacherName || "—")}</td>
      <td>${escapeHtml(fmtDate(r.deliveredAt))}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ========= Actions: delivery and stock adjust ========= */
async function confirmDelivery(){
  $("actionMsg").classList.add("hide");
  const classId = state.activeClassId;
  const mat = state.activeMaterial;
  if(!classId || !mat){ return; }

  const studentId = $("studentSelect").value;
  const student = state.students.find(s=>s.id===studentId);
  const studentName = student ? student.name : studentId;

  const teacherName = $("teacherInput").value.trim();
  if(!teacherName){
    showActionError("Informe o nome do professor.");
    return;
  }

  let qty = parseInt($("qtyInput").value, 10);
  if(!Number.isFinite(qty) || qty < 1){
    showActionError("Quantidade inválida.");
    return;
  }

  const stockRef = db.collection(COL.classStock).doc(classId).collection("items").doc(mat.id);
  const deliveriesRef = db.collection(COL.deliveries).doc();

  try{
    await db.runTransaction(async (tx) => {
      const stockSnap = await tx.get(stockRef);
      const current = stockSnap.exists ? Number(stockSnap.data().qty || 0) : 0;
      if(current < qty){
        throw new Error(`Sem saldo suficiente. Disponível: ${current}`);
      }
      tx.set(stockRef, { qty: current - qty, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      tx.set(deliveriesRef, {
        classId,
        materialId: mat.id,
        materialName: mat.name,
        studentId,
        studentName,
        qty,
        teacherName,
        deliveredAt: firebase.firestore.FieldValue.serverTimestamp(),
        deliveredByUid: auth.currentUser ? auth.currentUser.uid : null
      });
    });

    toast("Entrega registrada e estoque atualizado.");
    // refresh local stock
    const newQty = Number(state.stockByMaterialId.get(mat.id) || 0) - qty;
    state.stockByMaterialId.set(mat.id, newQty);
    $("modalQty").textContent = newQty;
    renderMaterialsGrid();

    // refresh deliveries list
    await loadDeliveriesForActiveMaterial();
    $("qtyInput").value = 1;
  }catch(err){
    console.error(err);
    showActionError(err.message || "Erro ao confirmar entrega.");
  }
}

async function applyStockAdjust(){
  $("actionMsg").classList.add("hide");
  const classId = state.activeClassId;
  const mat = state.activeMaterial;
  if(!classId || !mat) return;

  const delta = parseInt($("addQty").value, 10);
  if(!Number.isFinite(delta) || delta === 0){
    showActionError("Informe um número (ex.: 10 ou -3).");
    return;
  }

  const stockRef = db.collection(COL.classStock).doc(classId).collection("items").doc(mat.id);
  try{
    await db.runTransaction(async (tx)=>{
      const snap = await tx.get(stockRef);
      const current = snap.exists ? Number(snap.data().qty||0) : 0;
      const next = current + delta;
      if(next < 0) throw new Error(`Ajuste inválido: ficaria negativo (${next}).`);
      tx.set(stockRef, { qty: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    });

    const curr = Number(state.stockByMaterialId.get(mat.id) || 0);
    const next = curr + delta;
    state.stockByMaterialId.set(mat.id, next);
    $("modalQty").textContent = next;
    renderMaterialsGrid();
    toast("Estoque atualizado.");
    $("addQty").value = "";
  }catch(err){
    console.error(err);
    showActionError(err.message || "Erro ao ajustar estoque.");
  }
}

function showActionError(msg){
  $("actionMsg").textContent = msg;
  $("actionMsg").classList.remove("hide");
}

/* ========= Helpers ========= */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
